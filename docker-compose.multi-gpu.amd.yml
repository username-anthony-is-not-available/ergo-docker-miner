# This Docker Compose file is configured for a multi-GPU setup for AMD GPUs.
# It creates a separate container for each GPU, allowing you to customize
# the worker name and other settings for each one.

# To use this file, run the following command:
# sudo docker compose -f docker-compose.multi-gpu.amd.yml up -d --build

# By default, this file is configured for a two-GPU setup. To add more GPUs,
# copy the ergo-miner-gpu1 service and update the following:
# - Service name (e.g., ergo-miner-gpu2)
# - Container name (e.g., ergo-miner-gpu2)
# - WORKER_NAME (e.g., ergo-miner-gpu2)
# - GPU_DEVICES (e.g., 2)
# - Host ports (e.g., 4446:4444, 4459:4455, 4460:4456)

services:
  ergo-miner-gpu0:
    build:
      context: .
      dockerfile: Dockerfile.amd
      args:
        - LOLMINER_VERSION=${LOLMINER_VERSION:-1.98a}
    container_name: ergo-miner-gpu0
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - WORKER_NAME=ergo-miner-gpu0
      - GPU_DEVICES=0
    ports:
      - "4444:4444"
      - "4455:4455"
      - "4456:4456"
    devices:
      - "/dev/kfd:/dev/kfd"
      - "/dev/dri:/dev/dri"

  ergo-miner-gpu1:
    build:
      context: .
      dockerfile: Dockerfile.amd
      args:
        - LOLMINER_VERSION=${LOLMINER_VERSION:-1.98a}
    container_name: ergo-miner-gpu1
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - WORKER_NAME=ergo-miner-gpu1
      - GPU_DEVICES=1
    ports:
      - "4445:4444"
      - "4457:4455"
      - "4458:4456"
    devices:
      - "/dev/kfd:/dev/kfd"
      - "/dev/dri:/dev/dri"
