<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miner Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.2/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>Miner Dashboard (<span id="miner-type">--</span>) - <span id="miner-status">Starting...</span></h1>
        <div class="header-info">
            <span id="last-updated">Last Updated: Never</span>
        </div>
        <nav>
            <a href="/config">Configuration</a>
            <button onclick="restartMiner()" id="restart-btn">Restart Miner</button>
        </nav>
        <div class="stats-grid">
            <div class="stat-card">
                <h2>Total Hashrate</h2>
                <p id="total-hashrate">-- MH/s</p>
            </div>
            <div id="dual-hashrate-card" class="stat-card" style="display: none;">
                <h2>Total Dual Hashrate</h2>
                <p id="total-dual-hashrate">-- MH/s</p>
            </div>
            <div class="stat-card">
                <h2>Total Power</h2>
                <p id="total-power">-- W</p>
            </div>
            <div class="stat-card">
                <h2>Avg Temp</h2>
                <p id="avg-temp">-- °C</p>
            </div>
            <div class="stat-card">
                <h2>Uptime</h2>
                <p id="uptime">--</p>
            </div>
            <div class="stat-card">
                <h2>Efficiency</h2>
                <p id="total-efficiency">-- MH/W</p>
            </div>
        </div>

        <h2>System Information</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <h2>CPU Usage</h2>
                <p id="cpu-usage">-- %</p>
            </div>
            <div class="stat-card">
                <h2>RAM Usage</h2>
                <p id="ram-usage">-- %</p>
            </div>
            <div class="stat-card">
                <h2>Disk Usage</h2>
                <p id="disk-usage">-- %</p>
            </div>
            <div class="stat-card">
                <h2>Host Uptime</h2>
                <p id="host-uptime">--</p>
            </div>
        </div>

        <h2>Service Status</h2>
        <div class="stats-grid" id="service-status-container">
            <div class="stat-card">
                <h2>Metrics Exporter</h2>
                <p id="service-metrics">--</p>
            </div>
            <div class="stat-card">
                <h2>Profit Switcher</h2>
                <p id="service-profit">--</p>
            </div>
            <div class="stat-card">
                <h2>CUDA Monitor</h2>
                <p id="service-cuda">--</p>
            </div>
        </div>

        <h2>GPUs</h2>
        <div id="gpu-container">
        </div>
        <div class="stats-grid">
            <div class="chart-container">
                <h2>Hashrate History</h2>
                <canvas id="hashrate-chart"></canvas>
            </div>
            <div class="chart-container">
                <h2>Power Draw History</h2>
                <canvas id="power-chart"></canvas>
            </div>
        </div>

        <h2>Pool Profitability</h2>
        <div class="table-container">
            <table id="pool-stats-table">
                <thead>
                    <tr>
                        <th>Pool</th>
                        <th>Address</th>
                        <th>Profitability Score</th>
                    </tr>
                </thead>
                <tbody id="pool-stats-body">
                    <tr>
                        <td colspan="3">Loading pool stats...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section-header">
            <h2>Miner Logs</h2>
            <a href="/api/logs/download" class="btn-secondary">Download Full Log</a>
        </div>
        <div class="log-container">
            <pre id="miner-logs">Loading logs...</pre>
        </div>
    </div>
    <script>
        const socket = io();
        let hashrateChart, powerChart;

        socket.on('update', function(data) {
            if (data.miner) {
                document.getElementById('miner-type').innerText = data.miner;
            }
            if (data.status) {
                document.getElementById('miner-status').innerText = data.status;
                // Add color based on status
                if (data.status === 'Mining') {
                    document.getElementById('miner-status').style.color = '#4caf50';
                } else if (data.status.includes('Error')) {
                    document.getElementById('miner-status').style.color = '#f44336';
                } else {
                    document.getElementById('miner-status').style.color = '#ff9800';
                }
            }

            if (data.total_hashrate !== undefined) {
                document.getElementById('total-hashrate').innerText = `${data.total_hashrate.toFixed(2)} MH/s`;
            }
            if (data.total_power_draw !== undefined) {
                document.getElementById('total-power').innerText = `${data.total_power_draw.toFixed(1)} W`;
            }
            if (data.efficiency !== undefined) {
                document.getElementById('total-efficiency').innerText = `${data.efficiency.toFixed(3)} MH/W`;
            }
            if (data.avg_temperature !== undefined) {
                document.getElementById('avg-temp').innerText = `${data.avg_temperature.toFixed(1)} °C`;
            }
            document.getElementById('last-updated').innerText = `Last Updated: ${new Date().toLocaleTimeString()}`;

            if (data.total_dual_hashrate > 0) {
                document.getElementById('dual-hashrate-card').style.display = 'block';
                document.getElementById('total-dual-hashrate').innerText = `${data.total_dual_hashrate.toFixed(2)} MH/s`;
            } else {
                document.getElementById('dual-hashrate-card').style.display = 'none';
            }

            if (data.uptime !== undefined) {
                const uptimeSeconds = data.uptime;
                const hours = Math.floor(uptimeSeconds / 3600);
                const minutes = Math.floor((uptimeSeconds % 3600) / 60);
                const seconds = uptimeSeconds % 60;
                document.getElementById('uptime').innerText = `${hours}h ${minutes}m ${seconds}s`;
            }

            if (data.system_info) {
                document.getElementById('cpu-usage').innerText = `${data.system_info.cpu_usage.toFixed(1)} %`;
                document.getElementById('ram-usage').innerText = `${data.system_info.memory_usage.toFixed(1)} %`;
                document.getElementById('disk-usage').innerText = `${data.system_info.disk_usage.toFixed(1)} %`;

                const hostUptimeSeconds = Math.floor(data.system_info.host_uptime);
                const d = Math.floor(hostUptimeSeconds / 86400);
                const h = Math.floor((hostUptimeSeconds % 86400) / 3600);
                const m = Math.floor((hostUptimeSeconds % 3600) / 60);
                document.getElementById('host-uptime').innerText = `${d}d ${h}h ${m}m`;

                if (data.system_info.services) {
                    const services = data.system_info.services;
                    const updateService = (id, status) => {
                        const el = document.getElementById(id);
                        el.innerText = status;
                        if (status === 'Running') el.style.color = '#4caf50';
                        else if (status === 'Disabled') el.style.color = '#888';
                        else el.style.color = '#f44336';
                    };
                    updateService('service-metrics', services['metrics.py']);
                    updateService('service-profit', services['profit_switcher.py']);
                    updateService('service-cuda', services['cuda_monitor.sh']);
                }
            }

            if (data.gpus) {
                const gpuContainer = document.getElementById('gpu-container');
                data.gpus.forEach((gpu) => {
                    let gpuCard = document.getElementById(`gpu-${gpu.index}`);
                    if (!gpuCard) {
                        gpuCard = document.createElement('div');
                        gpuCard.className = 'gpu-card';
                        gpuCard.id = `gpu-${gpu.index}`;
                        gpuCard.innerHTML = `
                            <h3>GPU ${gpu.index}</h3>
                            <p><strong>Hashrate:</strong> <span class="hashrate">--</span> MH/s</p>
                            <p class="dual-hashrate-container" style="display: none;"><strong>Dual Hashrate:</strong> <span class="dual-hashrate">--</span> MH/s</p>
                            <p><strong>Efficiency:</strong> <span class="efficiency">--</span> MH/W</p>
                            <p><strong>Temp:</strong> <span class="temp">--</span>°C</p>
                            <p><strong>Power:</strong> <span class="power">--</span>W</p>
                            <p><strong>Fan Speed:</strong> <span class="fan-speed">--</span>%</p>
                            <p><strong>Shares:</strong> <span class="accepted">0</span> / <span class="rejected">0</span> <span class="share-alert" style="color: #f44336; display: none;">⚠️ High Rejects!</span></p>
                        `;
                        gpuContainer.appendChild(gpuCard);
                    }

                    gpuCard.querySelector('.hashrate').innerText = gpu.hashrate.toFixed(2);
                    if (gpu.dual_hashrate > 0) {
                        gpuCard.querySelector('.dual-hashrate-container').style.display = 'block';
                        gpuCard.querySelector('.dual-hashrate').innerText = gpu.dual_hashrate.toFixed(2);
                    } else {
                        gpuCard.querySelector('.dual-hashrate-container').style.display = 'none';
                    }

                    gpuCard.querySelector('.efficiency').innerText = gpu.efficiency.toFixed(3);
                    gpuCard.querySelector('.temp').innerText = gpu.temperature;
                    gpuCard.querySelector('.power').innerText = gpu.power_draw;
                    gpuCard.querySelector('.fan-speed').innerText = gpu.fan_speed;
                    gpuCard.querySelector('.accepted').innerText = gpu.accepted_shares;
                    gpuCard.querySelector('.rejected').innerText = gpu.rejected_shares;

                    const totalShares = gpu.accepted_shares + gpu.rejected_shares;
                    if (totalShares >= 10 && (gpu.rejected_shares / totalShares) > 0.1) {
                        gpuCard.querySelector('.share-alert').style.display = 'inline';
                    } else {
                        gpuCard.querySelector('.share-alert').style.display = 'none';
                    }
                });
            }

            if (data.history_point && hashrateChart && powerChart) {
                const point = data.history_point;
                const label = new Date(point.timestamp).toLocaleTimeString();

                hashrateChart.data.labels.push(label);
                hashrateChart.data.datasets[0].data.push(point.hashrate);
                if (hashrateChart.data.datasets.length > 1) {
                    hashrateChart.data.datasets[1].data.push(point.dual_hashrate);
                }

                powerChart.data.labels.push(label);
                powerChart.data.datasets[0].data.push(point.total_power_draw);

                // Keep only last 100 points
                if (hashrateChart.data.labels.length > 100) {
                    hashrateChart.data.labels.shift();
                    hashrateChart.data.datasets[0].data.shift();
                    if (hashrateChart.data.datasets.length > 1) hashrateChart.data.datasets[1].data.shift();

                    powerChart.data.labels.shift();
                    powerChart.data.datasets[0].data.shift();
                }

                hashrateChart.update('none');
                powerChart.update('none');
            }
        });

        async function restartMiner() {
            if (confirm('Are you sure you want to restart the miner?')) {
                const btn = document.getElementById('restart-btn');
                btn.disabled = true;
                btn.innerText = 'Restarting...';
                try {
                    const response = await fetch('/api/restart', { method: 'POST' });
                    const result = await response.json();
                    alert(result.message);
                } catch (error) {
                    alert('Failed to restart miner');
                } finally {
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerText = 'Restart Miner';
                    }, 5000);
                }
            }
        }

        async function fetchHashrateHistory() {
            const response = await fetch('/hashrate-history');
            const data = await response.json();
            return data;
        }

        async function renderCharts() {
            const history = await fetchHashrateHistory();
            const hashrateCtx = document.getElementById('hashrate-chart').getContext('2d');
            const powerCtx = document.getElementById('power-chart').getContext('2d');

            const hashrateDatasets = [{
                label: 'Primary Hashrate (MH/s)',
                data: history.map(d => d.hashrate),
                borderColor: 'rgba(75, 192, 192, 1)',
                tension: 0.1,
                fill: false
            }];

            if (history.some(d => d.dual_hashrate > 0)) {
                hashrateDatasets.push({
                    label: 'Dual Hashrate (MH/s)',
                    data: history.map(d => d.dual_hashrate),
                    borderColor: 'rgba(153, 102, 255, 1)',
                    tension: 0.1,
                    fill: false
                });
            }

            hashrateChart = new Chart(hashrateCtx, {
                type: 'line',
                data: {
                    labels: history.map(d => new Date(d.timestamp).toLocaleTimeString()),
                    datasets: hashrateDatasets
                },
                options: {
                    responsive: true,
                    animation: false,
                    scales: { y: { beginAtZero: true } }
                }
            });

            powerChart = new Chart(powerCtx, {
                type: 'line',
                data: {
                    labels: history.map(d => new Date(d.timestamp).toLocaleTimeString()),
                    datasets: [{
                        label: 'Total Power Draw (W)',
                        data: history.map(d => d.total_power_draw),
                        borderColor: 'rgba(255, 99, 132, 1)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    animation: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        renderCharts();

        async function fetchPoolStats() {
            try {
                const response = await fetch('/api/pool-stats');
                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                const tbody = document.getElementById('pool-stats-body');
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3">No pool stats available.</td></tr>';
                    return;
                }
                data.forEach(pool => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${pool.name}</td>
                        <td>${pool.address}</td>
                        <td>${pool.score.toFixed(4)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error fetching pool stats:', error);
                document.getElementById('pool-stats-body').innerHTML = '<tr><td colspan="3">Error loading pool stats.</td></tr>';
            }
        }

        fetchPoolStats();
        setInterval(fetchPoolStats, 300000); // Update every 5 minutes

        async function fetchLogs() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();
                const logElement = document.getElementById('miner-logs');
                if (data.logs) {
                    logElement.innerText = data.logs;
                    logElement.scrollTop = logElement.scrollHeight;
                }
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }

        // Fetch logs every 10 seconds
        setInterval(fetchLogs, 10000);
        fetchLogs();
    </script>
</body>
</html>
