<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miner Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.2/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>Miner Dashboard (<span id="miner-type">--</span>)</h1>
        <nav>
            <a href="/config">Configuration</a>
            <button onclick="restartMiner()" id="restart-btn">Restart Miner</button>
        </nav>
        <div class="stats-grid">
            <div class="stat-card">
                <h2>Total Hashrate</h2>
                <p id="total-hashrate">-- MH/s</p>
            </div>
            <div id="dual-hashrate-card" class="stat-card" style="display: none;">
                <h2>Total Dual Hashrate</h2>
                <p id="total-dual-hashrate">-- MH/s</p>
            </div>
            <div class="stat-card">
                <h2>Uptime</h2>
                <p id="uptime">--</p>
            </div>
        </div>
        <h2>GPUs</h2>
        <div id="gpu-container">
        </div>
        <h2>Hashrate History</h2>
        <div class="chart-container">
            <canvas id="hashrate-chart"></canvas>
        </div>
    </div>
    <script>
        const socket = io();

        socket.on('update', function(data) {
            document.getElementById('miner-type').innerText = data.miner;
            document.getElementById('total-hashrate').innerText = `${data.total_hashrate.toFixed(2)} MH/s`;

            if (data.total_dual_hashrate > 0) {
                document.getElementById('dual-hashrate-card').style.display = 'block';
                document.getElementById('total-dual-hashrate').innerText = `${data.total_dual_hashrate.toFixed(2)} MH/s`;
            } else {
                document.getElementById('dual-hashrate-card').style.display = 'none';
            }

            const uptimeSeconds = data.uptime;
            const hours = Math.floor(uptimeSeconds / 3600);
            const minutes = Math.floor((uptimeSeconds % 3600) / 60);
            const seconds = uptimeSeconds % 60;
            document.getElementById('uptime').innerText = `${hours}h ${minutes}m ${seconds}s`;

            const gpuContainer = document.getElementById('gpu-container');
            data.gpus.forEach((gpu) => {
                let gpuCard = document.getElementById(`gpu-${gpu.index}`);
                if (!gpuCard) {
                    gpuCard = document.createElement('div');
                    gpuCard.className = 'gpu-card';
                    gpuCard.id = `gpu-${gpu.index}`;
                    gpuCard.innerHTML = `
                        <h3>GPU ${gpu.index}</h3>
                        <p><strong>Hashrate:</strong> <span class="hashrate">--</span> MH/s</p>
                        <p class="dual-hashrate-container" style="display: none;"><strong>Dual Hashrate:</strong> <span class="dual-hashrate">--</span> MH/s</p>
                        <p><strong>Temp:</strong> <span class="temp">--</span>Â°C</p>
                        <p><strong>Power:</strong> <span class="power">--</span>W</p>
                        <p><strong>Fan Speed:</strong> <span class="fan-speed">--</span>%</p>
                        <p><strong>Shares:</strong> <span class="accepted">0</span> / <span class="rejected">0</span></p>
                    `;
                    gpuContainer.appendChild(gpuCard);
                }

                gpuCard.querySelector('.hashrate').innerText = gpu.hashrate.toFixed(2);
                if (gpu.dual_hashrate > 0) {
                    gpuCard.querySelector('.dual-hashrate-container').style.display = 'block';
                    gpuCard.querySelector('.dual-hashrate').innerText = gpu.dual_hashrate.toFixed(2);
                } else {
                    gpuCard.querySelector('.dual-hashrate-container').style.display = 'none';
                }

                gpuCard.querySelector('.temp').innerText = gpu.temperature;
                gpuCard.querySelector('.power').innerText = gpu.power_draw;
                gpuCard.querySelector('.fan-speed').innerText = gpu.fan_speed;
                gpuCard.querySelector('.accepted').innerText = gpu.accepted_shares;
                gpuCard.querySelector('.rejected').innerText = gpu.rejected_shares;
            });
        });

        async function restartMiner() {
            if (confirm('Are you sure you want to restart the miner?')) {
                const btn = document.getElementById('restart-btn');
                btn.disabled = true;
                btn.innerText = 'Restarting...';
                try {
                    const response = await fetch('/api/restart', { method: 'POST' });
                    const result = await response.json();
                    alert(result.message);
                } catch (error) {
                    alert('Failed to restart miner');
                } finally {
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerText = 'Restart Miner';
                    }, 5000);
                }
            }
        }

        async function fetchHashrateHistory() {
            const response = await fetch('/hashrate-history');
            const data = await response.json();
            return data;
        }

        async function renderHashrateChart() {
            const history = await fetchHashrateHistory();
            const ctx = document.getElementById('hashrate-chart').getContext('2d');

            const datasets = [{
                label: 'Primary Hashrate (MH/s)',
                data: history.map(d => d.hashrate),
                borderColor: 'rgba(75, 192, 192, 1)',
                tension: 0.1
            }];

            if (history.some(d => d.dual_hashrate > 0)) {
                datasets.push({
                    label: 'Dual Hashrate (MH/s)',
                    data: history.map(d => d.dual_hashrate),
                    borderColor: 'rgba(153, 102, 255, 1)',
                    tension: 0.1
                });
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map(d => new Date(d.timestamp).toLocaleTimeString()),
                    datasets: datasets
                }
            });
        }

        renderHashrateChart();
    </script>
</body>
</html>
