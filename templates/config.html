<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miner Configuration</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>Miner Configuration</h1>
        <nav>
            <a href="/">Dashboard</a>
        </nav>
        <form id="config-form">
            <div class="form-group">
                <label for="miner">Miner</label>
                <select id="miner" name="MINER">
                    <option value="lolminer">lolMiner</option>
                    <option value="t-rex">T-Rex</option>
                </select>
            </div>
            <div class="form-group">
                <label for="pool_address">Pool Address</label>
                <input type="text" id="pool_address" name="POOL_ADDRESS">
            </div>
            <div class="form-group">
                <label for="backup_pool_address">Backup Pool Address</label>
                <input type="text" id="backup_pool_address" name="BACKUP_POOL_ADDRESS">
            </div>
            <div class="form-group">
                <label for="wallet_address">Wallet Address</label>
                <input type="text" id="wallet_address" name="WALLET_ADDRESS">
            </div>
            <div class="form-group">
                <label for="worker_name">Worker Name</label>
                <input type="text" id="worker_name" name="WORKER_NAME">
            </div>
            <div class="form-group">
                <label for="gpu_devices">GPU Devices</label>
                <input type="text" id="gpu_devices" name="GPU_DEVICES">
            </div>
            <div class="form-group">
                <label for="extra_args">Extra Arguments</label>
                <input type="text" id="extra_args" name="EXTRA_ARGS">
            </div>
            <hr>
            <h2>Profit Switching</h2>
            <div class="form-group">
                <label for="auto_profit_switching">Enable Auto Profit Switching</label>
                <input type="checkbox" id="auto_profit_switching" name="AUTO_PROFIT_SWITCHING">
            </div>
            <div class="form-group">
                <label for="profit_switching_threshold">Switching Threshold (e.g. 0.005)</label>
                <input type="number" id="profit_switching_threshold" name="PROFIT_SWITCHING_THRESHOLD" step="0.001">
            </div>
            <div class="form-group">
                <label for="profit_switching_interval">Switching Interval (seconds)</label>
                <input type="number" id="profit_switching_interval" name="PROFIT_SWITCHING_INTERVAL">
            </div>
            <hr>
            <h2>Dual Mining (lolMiner only)</h2>
            <div class="form-group">
                <label for="dual_algo">Dual Algorithm</label>
                <select id="dual_algo" name="DUAL_ALGO">
                    <option value="">None</option>
                    <option value="KASPADUAL">Kaspa (KASPADUAL)</option>
                    <option value="ALEPHDUAL">Alephium (ALEPHDUAL)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="dual_pool">Dual Pool Address</label>
                <input type="text" id="dual_pool" name="DUAL_POOL">
            </div>
            <div class="form-group">
                <label for="dual_wallet">Dual Wallet Address</label>
                <input type="text" id="dual_wallet" name="DUAL_WALLET">
            </div>
            <div class="form-group">
                <label for="dual_worker">Dual Worker Name</label>
                <input type="text" id="dual_worker" name="DUAL_WORKER">
            </div>
            <hr>
            <h2>Telegram Notifications</h2>
            <div class="form-group">
                <label for="telegram_enable">Enable Telegram Notifications</label>
                <input type="checkbox" id="telegram_enable" name="TELEGRAM_ENABLE">
            </div>
            <div class="form-group">
                <label for="telegram_bot_token">Telegram Bot Token</label>
                <input type="text" id="telegram_bot_token" name="TELEGRAM_BOT_TOKEN">
            </div>
            <div class="form-group">
                <label for="telegram_chat_id">Telegram Chat ID</label>
                <input type="text" id="telegram_chat_id" name="TELEGRAM_CHAT_ID">
            </div>
            <div class="form-group">
                <label for="telegram_notify_threshold">Notification Threshold (seconds)</label>
                <input type="number" id="telegram_notify_threshold" name="TELEGRAM_NOTIFY_THRESHOLD">
            </div>
            <hr>
            <h2>Overclocking</h2>
            <div class="form-group">
                <label for="apply_oc">Apply Overclocking</label>
                <input type="checkbox" id="apply_oc" name="APPLY_OC">
            </div>
            <div class="form-group">
                <label for="eco_mode">Enable Eco Mode</label>
                <input type="checkbox" id="eco_mode" name="ECO_MODE">
            </div>
            <div class="form-group">
                <label for="gpu_profile">GPU Profile</label>
                <input type="text" id="gpu_profile" name="GPU_PROFILE">
            </div>
            <div class="form-group">
                <label for="gpu_clock_offset">GPU Clock Offset</label>
                <input type="number" id="gpu_clock_offset" name="GPU_CLOCK_OFFSET">
            </div>
            <div class="form-group">
                <label for="gpu_mem_offset">GPU Memory Offset</label>
                <input type="number" id="gpu_mem_offset" name="GPU_MEM_OFFSET">
            </div>
            <div class="form-group">
                <label for="gpu_power_limit">GPU Power Limit</label>
                <input type="number" id="gpu_power_limit" name="GPU_POWER_LIMIT">
            </div>
            <hr>
            <h2>Stability & Maintenance</h2>
            <div class="form-group">
                <label for="auto_restart_on_cuda_error">Auto-Restart on CUDA Error</label>
                <input type="checkbox" id="auto_restart_on_cuda_error" name="AUTO_RESTART_ON_CUDA_ERROR">
            </div>
            <hr>
            <h2>Ergo Node Integration</h2>
            <div class="form-group">
                <label for="check_node_sync">Pause mining if local Ergo node is out of sync</label>
                <input type="checkbox" id="check_node_sync" name="CHECK_NODE_SYNC">
            </div>
            <div class="form-group">
                <label for="node_url">Ergo Node API URL</label>
                <input type="text" id="node_url" name="NODE_URL" placeholder="http://localhost:9053">
            </div>
            <button type="submit">Save</button>
        </form>
        <button id="restart-miner">Restart Miner</button>
        <div id="status-message"></div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch current config and populate the form
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    if (data.MINER) document.getElementById('miner').value = data.MINER;
                    document.getElementById('pool_address').value = data.POOL_ADDRESS || '';
                    document.getElementById('backup_pool_address').value = data.BACKUP_POOL_ADDRESS || '';
                    document.getElementById('wallet_address').value = data.WALLET_ADDRESS || '';
                    document.getElementById('worker_name').value = data.WORKER_NAME || '';
                    document.getElementById('gpu_devices').value = data.GPU_DEVICES || '';
                    document.getElementById('extra_args').value = data.EXTRA_ARGS || '';
                    document.getElementById('auto_profit_switching').checked = data.AUTO_PROFIT_SWITCHING === 'true';
                    document.getElementById('profit_switching_threshold').value = data.PROFIT_SWITCHING_THRESHOLD || 0.005;
                    document.getElementById('profit_switching_interval').value = data.PROFIT_SWITCHING_INTERVAL || 3600;
                    document.getElementById('apply_oc').checked = data.APPLY_OC === 'true';
                    document.getElementById('eco_mode').checked = data.ECO_MODE === 'true';
                    document.getElementById('gpu_profile').value = data.GPU_PROFILE || '';
                    document.getElementById('gpu_clock_offset').value = data.GPU_CLOCK_OFFSET || 0;
                    document.getElementById('gpu_mem_offset').value = data.GPU_MEM_OFFSET || 0;
                    document.getElementById('gpu_power_limit').value = data.GPU_POWER_LIMIT || 0;
                    document.getElementById('auto_restart_on_cuda_error').checked = data.AUTO_RESTART_ON_CUDA_ERROR === 'true';
                    document.getElementById('check_node_sync').checked = data.CHECK_NODE_SYNC === 'true';
                    document.getElementById('node_url').value = data.NODE_URL || '';

                    // Dual Mining
                    document.getElementById('dual_algo').value = data.DUAL_ALGO || '';
                    document.getElementById('dual_pool').value = data.DUAL_POOL || '';
                    document.getElementById('dual_wallet').value = data.DUAL_WALLET || '';
                    document.getElementById('dual_worker').value = data.DUAL_WORKER || '';

                    // Telegram
                    document.getElementById('telegram_enable').checked = data.TELEGRAM_ENABLE === 'true';
                    document.getElementById('telegram_bot_token').value = data.TELEGRAM_BOT_TOKEN || '';
                    document.getElementById('telegram_chat_id').value = data.TELEGRAM_CHAT_ID || '';
                    document.getElementById('telegram_notify_threshold').value = data.TELEGRAM_NOTIFY_THRESHOLD || 300;
                });
            // Handle form submission
            document.getElementById('config-form').addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                const data = {};
                for (const [key, value] of formData.entries()) {
                    data[key] = value;
                }
                data['APPLY_OC'] = document.getElementById('apply_oc').checked;
                data['ECO_MODE'] = document.getElementById('eco_mode').checked;
                data['AUTO_PROFIT_SWITCHING'] = document.getElementById('auto_profit_switching').checked;
                data['PROFIT_SWITCHING_THRESHOLD'] = document.getElementById('profit_switching_threshold').value;
                data['PROFIT_SWITCHING_INTERVAL'] = document.getElementById('profit_switching_interval').value;
                data['AUTO_RESTART_ON_CUDA_ERROR'] = document.getElementById('auto_restart_on_cuda_error').checked;
                data['TELEGRAM_ENABLE'] = document.getElementById('telegram_enable').checked;
                data['CHECK_NODE_SYNC'] = document.getElementById('check_node_sync').checked;
                data['NODE_URL'] = document.getElementById('node_url').value;

                fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                }).then(response => {
                    const statusMessage = document.getElementById('status-message');
                    if (response.ok) {
                        statusMessage.textContent = 'Configuration saved successfully!';
                        statusMessage.className = 'success';
                    } else {
                        statusMessage.textContent = 'Error saving configuration.';
                        statusMessage.className = 'error';
                    }
                });
            });
            // Handle restart button click
            document.getElementById('restart-miner').addEventListener('click', function() {
                fetch('/api/restart', {
                    method: 'POST'
                }).then(response => {
                    const statusMessage = document.getElementById('status-message');
                    if (response.ok) {
                        statusMessage.textContent = 'Miner restarting...';
                        statusMessage.className = 'success';
                    } else {
                        statusMessage.textContent = 'Error restarting miner.';
                        statusMessage.className = 'error';
                    }
                });
            });
        });
    </script>
</body>
</html>
